

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>上手实践：ERC20合约测试 &mdash; 以太坊的指南针 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="附录 有意思的冷知识" href="../ch10/index.html" />
    <link rel="prev" title="上手实践：ERC20合约" href="erc20.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> 以太坊的指南针
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../howto.html">如何学习这本书</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch1/index.html">第 1 章 以太坊：一台全球计算机</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch1/born.html">简史</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/progress.html">发展阶段</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch1/highlight.html">以太坊的特色</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch2/index.html">第 2 章 账户是什么</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch2/basic.html">小白基础知识问答</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id2">我的以太币记录在哪里？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id3">我的以太币余额如何变化？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id4">什么是区块？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id5">区块和状态的关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id6">“巨大的账本”</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id7">我如何参与以太坊？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/basic.html#id8">我如何与其他人同步账本？</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/account.html">账户探秘</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch2/account.html#id2">账户与账户状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/account.html#id3">账户状态的内涵</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../ch2/account.html#id4">已执行交易总数</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ch2/account.html#id5">持币数量</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ch2/account.html#id6">存储区的哈希值</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ch2/account.html#id7">代码区的哈希值</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/account.html#app">没有钱包App, 如何生成账户？</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch2/account.html#id11">智能合约地址的生成</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/interval.html">扩展阅读</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/keystore.html">资料篇：Keystore 与私钥保存</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/app.html">资料篇：常用钱包 App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch2/eip55.html">资料篇：EIP-55 格式的账户地址</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch3/index.html">第 3 章 交易是驱动力</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch3/how.html">交易的发送</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch3/how.html#id2">交易与消息的区别</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch3/how.html#id3">交易的特性是什么？</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/what.html">交易的样子</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/life.html">交易的生命周期</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/interval.html">扩展阅读</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/pow.html">资料篇：共识与工作量证明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch3/pow.html#pow">比特币的PoW机制（简单版）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch3/pow.html#id2">比特币算力的中心化问题</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch3/pow.html#pow-pos">以太坊的Pow/Pos机制</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch3/dig.html">资料篇：矿工与挖矿奖励</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch4/index.html">第 4 章 数据结构</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch4/radix.html">Radix树</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/merkle.html">Merkle树和 Merkle证明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/mpt.html">Merkle Patricia树</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/rlp.html">RLP编码</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch4/rlp.html#id1">RLP字符/字符串编码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch4/rlp.html#id2">RLP字符/字符串解码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch4/rlp.html#id3">RLP数组编码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch4/rlp.html#id4">RLP数组解码</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/interval.html">扩展阅读</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/stateroot.html">资料篇：状态树 (以及存储树）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/transroot.html">资料篇：交易树</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/receiptroot.html">资料篇：收据树</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch4/block.html">资料篇：区块</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch5/index.html">第 5 章 构建一条以太坊私链</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch5/install.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/geth.html">Geth客户端的结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/build.html">启动一条以太坊私链</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/coinbase.html">接收挖矿奖励</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch5/transfer.html">转账与收款</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch6/index.html">第 6 章 手把手教你部署智能合约</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch6/what.html">什么是智能合约？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/install.html">安装编译器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/compile.html">Solc编译智能合约</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/prepare.html">智能合约发布准备</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/deploy.html">部署智能合约</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch6/call.html">调用智能合约</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch7/index.html">第 7 章 以太坊虚拟机探秘</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch7/result.html">虚拟机的执行结果</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/resource.html">虚拟机的执行资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/call.html">合约调用合约?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/io.html">虚拟机的输入输出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/gas.html">Gas 花费与退回</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch7/instructions.html">虚拟机指令集</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch8/index.html">第 8 章 Solidity语法练习</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch8/basic.html">基础概念</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id2">没有浮点数运算</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id3">合约基础</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id4">变量类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id5">运算符号</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#struct">结构体 Struct</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#array">数组array</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id6">函数申明</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id7">类型转换与内置函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/basic.html#id8">合约与事件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/levelup.html">语法进阶</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#map">数据结构：map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#msg-sender">环境变量：msg.sender</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#requireassert">require还是assert?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#id2">继承和引入</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#id3">省钱妙招：内存变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#id4">接口与合约调用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/levelup.html#id5">多返回值</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/advanced.html">高级语法和概念</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#contract">Contract 构造函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#ownable">Ownable控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#pausable">Pausable控制</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#struct">省钱妙招：struct 结构体</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#id2">时间单位表达</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#id3">带参数的函数修饰符</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#for">for 循环</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#payable">合约收款：payable修饰符</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch8/advanced.html#transfer">支付费用：transfer方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch8/summary.html">小结</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">第 9 章 Truffle合约开发实战</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">编译、测试工具安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="install.html#truffle">Truffle的安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="install.html#ganache">Ganache的安装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sample.html">Truffle启动样例项目</a><ul>
<li class="toctree-l3"><a class="reference internal" href="sample.html#id1">下载样例</a></li>
<li class="toctree-l3"><a class="reference internal" href="sample.html#id2">编译项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="sample.html#ganache">部署项目到 Ganache</a></li>
<li class="toctree-l3"><a class="reference internal" href="sample.html#id3">测试项目</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="erc20.html">上手实践：ERC20合约</a><ul>
<li class="toctree-l3"><a class="reference internal" href="erc20.html#id1">新建项目目录</a></li>
<li class="toctree-l3"><a class="reference internal" href="erc20.html#erc20-basic">ERC20 Basic合约接口</a></li>
<li class="toctree-l3"><a class="reference internal" href="erc20.html#id2">ERC20 合约接口</a></li>
<li class="toctree-l3"><a class="reference internal" href="erc20.html#safemath">SafeMath基础数学库</a></li>
<li class="toctree-l3"><a class="reference internal" href="erc20.html#cat">猫币：CAT数字资产合约</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">上手实践：ERC20合约测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">准备工作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">测试辅助函数与库</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">测试代码分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">测试运行与结果</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ch10/index.html">附录 有意思的冷知识</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ch10/shortattack.html">短地址攻击</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/block.html">比特币的区块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/utxo.html">以太坊与比特币账户的区别</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch10/utxo.html#id2">隐私与安全性的比较</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch10/utxo.html#id3">数据体积与并发能力</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch10/utxo.html#id4">发送交易时对双花的处理</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/triangle.html">“不可能的三角”问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ch10/ethash.html">ETHASH 挖矿算法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ch10/ethash.html#ethashpow">ETHASH和比特币PoW的异同</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch10/ethash.html#id1">ETHASH的设计目标</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch10/ethash.html#id2">ETHASH的挖矿运行总流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ch10/ethash.html#id3">ETHASH算法源代码解读</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">以太坊的指南针</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          



















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">第 9 章 Truffle合约开发实战</a> &raquo;</li>
        
      <li>上手实践：ERC20合约测试</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/laalaguer/ethereum-compass/blob/master/ch9/test.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="erc20">
<h1>上手实践：ERC20合约测试<a class="headerlink" href="#erc20" title="Permalink to this headline">¶</a></h1>
<p>在Truffle的测试中，我们选用 Ganache(Test_RPC)作为底层的区块链节点。它具有良好的通讯与实时反馈能力，而且它的块也是按需打包，每发生交易才会出新的区块（回忆第6章我们反复启动、暂停挖矿的繁琐，Ganache帮我们代劳了这部分工作），避免了资源的浪费。要测试ERC20的合约，我们必须覆盖到全部6个方法，并且进行反复的尝试，试整型溢出、测试授权不足、测试余额不足，并且我们要测试调用失败时是否会返回之前的状态。</p>
<div class="section" id="id1">
<h2>准备工作<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Truffle 引用结构都以目录为准，相对比较宽松，我们新建一个helpers目录并加一个文件，用来存放我们测试所用的函数断言的辅助函数；另外我们再添加一个与智能合约同名的JavaScript测试文件作为测试的剧本；此外因为我们程序中的数字都比较大，我们需要额外引用一个大数字的处理库来帮助我们处理大数字加减法。</p>
<p>安装大数字处理库bignumber.js</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ npm install --save bignumber.js
</pre></div>
</div>
<p>添加Revert相关断言助手assertRevert.js，稍后填充具代码。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir helpers
$ touch assertRevert.js
</pre></div>
</div>
<p>添加测试主文件Cat.js</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> test/
$ touch Cat.js
</pre></div>
</div>
<p>至此，我们的项目基本文件已经完整，完整项目结构如下。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>erc20-test/
├── contracts
│   ├── Cat.sol
│   ├── ERC20.sol
│   ├── ERC20Basic.sol
│   ├── Migrations.sol
│   └── SafeMath.sol
├── helpers
│   └── assertRevert.js
├── migrations
│   └── 1_initial_migration.js
├── node_modules
│   └── bignumber.js
│       ├── CHANGELOG.md
│       ├── LICENCE
│       ├── README.md
│       ├── bignumber.d.ts
│       ├── bignumber.js
│       ├── bignumber.js.map
│       ├── bignumber.min.js
│       ├── bignumber.mjs
│       ├── bower.json
│       ├── doc
│       │   └── API.html
│       └── package.json
├── package-lock.json
├── <span class="nb">test</span>
│   └── Cat.js
├── truffle-config.js
└── truffle.js
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>测试辅助函数与库<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Mocha框架和Chai断言库（测试中的库）都不是为了以太坊测试而专门设计的，为了在测试中，探测到一笔交易失败后是状态重置了退回了，还是直接异常了扣完了所有的gas费，我们需要有一个revert关键词的判断助手，所以我们编写了assertRevert.js助手函数库。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="kd">function</span> <span class="nx">assertRevert</span> <span class="p">(</span><span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">promise</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">revertFound</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s1">&#39;revert&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="nx">assert</span><span class="p">(</span><span class="nx">revertFound</span><span class="p">,</span> <span class="sb">`Expected &quot;revert&quot;, got </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb"> instead`</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;Expected revert not received&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">assertRevert</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>函数代码比较简单，就是在异常后返回的 Promise 值里面判断是否有带revert关键字。</p>
</div>
<div class="section" id="id3">
<h2>测试代码分析<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>我们来逐步构建Cat.js 测试剧本。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">Cat</span> <span class="o">=</span> <span class="nx">artifacts</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;Cat&#39;</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">BigNumber</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bignumber.js&#39;</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">assertRevert</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../helpers/assertRevert&#39;</span><span class="p">);</span>

<span class="nx">contract</span><span class="p">(</span><span class="s1">&#39;Cat&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">accounts</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">symbolName</span> <span class="o">=</span> <span class="s1">&#39;CAT&#39;</span>
  <span class="kd">const</span> <span class="nx">decimals</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">18</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">allTokens</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BigNumber</span><span class="p">(</span><span class="mf">10000000000e18</span><span class="p">)</span>

  <span class="kd">let</span> <span class="nx">catInstance</span>

  <span class="kd">const</span> <span class="nx">deployer</span> <span class="o">=</span> <span class="nx">accounts</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">user1</span> <span class="o">=</span> <span class="nx">accounts</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">user2</span> <span class="o">=</span> <span class="nx">accounts</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="s1">&#39;setup contract for each test&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">catInstance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Cat</span><span class="p">.</span><span class="k">new</span><span class="p">()</span>
  <span class="p">})</span>
</pre></div>
</div>
<p>在开头我们引用了artifacts.require(‘Cat’)获取到CAT智能合约的ABI，我们就具备了部署它、和它互动的方法。接着引入了bignumber 来处理大数字，还有我们亲自编写的assertRevert库辅助我们检查交易失败时revert关键行为有没有触发。我们用合约关键字contract开头，表示我们要测试一个合约。在接下来我们设立了三个账户：合约部署账户、用户1和用户2（代码中为deployer,user1, user2）。</p>
<p>这里尤其注意的是，我们调用了beforeEach()函数，让每一次测试之前我们都部署一个新的合约，这样有利于合约存储空间的初始化，让每个合约测试互不干扰。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Initla deployment&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;totalSupply&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns 1 * (10 ** 10) * (10 ** 18)&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="kd">const</span> <span class="nx">total</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">totalSupply</span><span class="p">()</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">total</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">allTokens</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns correct symbol name&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">const</span> <span class="nx">symbol</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">symbol</span><span class="p">()</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">symbolName</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Mocha 框架通过describe关键字来将测试语句分组，每个分组包含了多个子describe 语句。我们在初始化阶段检查Cat合约的符号和发行总量是否符合我们的预期。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;init balance&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;user1 has no tokens&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns zero&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">)</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">balance</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;deployer has all tokens&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns the total amount of tokens&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">deployer</span><span class="p">)</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">balance</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">allTokens</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>在合约创世后，我们检查构造函数是否如约定将所有的CAT币转移给了创始人 deployer，并检查用户1的账户里面持有CAT币的数量为0。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;transfer&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;normal transfers&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;transfers among deployer, user1, user2&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="c1">// Success: transfer all tokens deployer =&gt; user1</span>
      <span class="kd">let</span> <span class="nx">amount1</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10000000000</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">value1</span> <span class="o">=</span> <span class="nx">amount1</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="nx">pow</span><span class="p">(</span><span class="nx">decimals</span><span class="p">))</span>

      <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">user1</span><span class="p">,</span> <span class="nx">value1</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">deployer</span> <span class="p">})</span>
      <span class="kd">let</span> <span class="nx">deployerBalance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">deployer</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">user1Balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">)</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">deployerBalance</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user1Balance</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">value1</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>

      <span class="c1">// Success: transfer 500 tokens user1 =&gt; user2</span>
      <span class="kd">let</span> <span class="nx">amount2</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">500</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">value2</span> <span class="o">=</span> <span class="nx">amount2</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="nx">pow</span><span class="p">(</span><span class="nx">decimals</span><span class="p">))</span>

      <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">user2</span><span class="p">,</span> <span class="nx">value2</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">})</span>
      <span class="kd">let</span> <span class="nx">user1Balance_new</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">user2Balance_new</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user2</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user2Balance_new</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">value2</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user1Balance</span><span class="p">.</span><span class="nx">minus</span><span class="p">(</span><span class="nx">user1Balance_new</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">value2</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;abnormal transfers&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;throws on insufficient balance&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="c1">// Fail: insufficient funds</span>
      <span class="kd">let</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">amount</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="nx">pow</span><span class="p">(</span><span class="nx">decimals</span><span class="p">))</span>

      <span class="k">await</span> <span class="nx">assertRevert</span><span class="p">(</span><span class="nx">catInstance</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">user1</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user2</span> <span class="p">}))</span>
      <span class="kd">let</span> <span class="nx">user1Balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">user2Balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user2</span><span class="p">)</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user1Balance</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user2Balance</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</pre></div>
</div>
<p>在上述代码中，我们对Transfer转账相关的函数进行了深入测试。我们首先进行了一笔正常的转账，将创始人deployer持有的所有CAT币转移给用户1，再将部分CAT币从用户1转移到用户2。</p>
<p>我们接着进行了不正常的转账，从一个余额不足的账户转账出来，这里我们希望引发一场，并且让交易放弃执行，转而触发 revert()函数回到测试开头的状态。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;normal allow&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;allows user1 to transfer from deployer&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">let</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">amount</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="nx">pow</span><span class="p">(</span><span class="nx">decimals</span><span class="p">))</span>

      <span class="c1">// Approve transfer</span>
      <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">user1</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">deployer</span> <span class="p">})</span>
      <span class="c1">// Check allowance</span>
      <span class="kd">let</span> <span class="nx">allowance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">allowance</span><span class="p">(</span><span class="nx">deployer</span><span class="p">,</span> <span class="nx">user1</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">})</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">allowance</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>

      <span class="c1">// Success: transferFrom</span>
      <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">deployer</span><span class="p">,</span> <span class="nx">user1</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">})</span>
      <span class="c1">// Check balance and allowance</span>
      <span class="kd">let</span> <span class="nx">allowance_new</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">allowance</span><span class="p">(</span><span class="nx">deployer</span><span class="p">,</span> <span class="nx">user1</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">})</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">allowance_new</span><span class="p">,</span> <span class="mf">0</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">user1Balance</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">catInstance</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">user1</span><span class="p">)</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user1Balance</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;abnormal allow&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;throws on insufficient balance&#39;</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="kd">let</span> <span class="nx">amount</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">1000</span><span class="p">)</span>
      <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">amount</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toBigNumber</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="nx">pow</span><span class="p">(</span><span class="nx">decimals</span><span class="p">))</span>

      <span class="c1">// Success: approve transfer</span>
      <span class="nx">catInstance</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">user2</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">})</span>
      <span class="c1">// Fail: cannot transfer</span>
      <span class="k">await</span> <span class="nx">assertRevert</span><span class="p">(</span><span class="nx">catInstance</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">user1</span><span class="p">,</span> <span class="nx">user2</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">{</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">user1</span> <span class="p">}))</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>

<span class="p">})</span>
</pre></div>
</div>
<p>我们最后对 approve() 类型的函数进行测试。首先进行了一次正常的授权，并且在授权后调用 transferFrom()函数将该授权兑现，转走一定数量的CAT币。接着我们又进行了异常测试，让授权照常进行，但是账户余额却不足。此时验证transferFrom()会因为余额不足而失败，触发 revert()让账户状态回到测试开始的样子。</p>
<p>至此，一份完整的 Cat.js 测试文件已经呈现在读者眼前，我们将它保存下来，执行测试吧！</p>
</div>
<div class="section" id="id4">
<h2>测试运行与结果<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>请确保你的 Ganache 节点已经启动</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ganache-cli
</pre></div>
</div>
<p>代码的测试过程很简洁，仅需要运行一行命令就可以让truffle帮我们编译、部署、测试。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ truffle <span class="nb">test</span>
Compiling ./contracts/Cat.sol...
Compiling ./contracts/ERC20.sol...
Compiling ./contracts/ERC20Basic.sol...
Compiling ./contracts/Migrations.sol...
Compiling ./contracts/SafeMath.sol...


  Contract: Cat
    Initla deployment
      totalSupply
        ✓ returns <span class="m">1</span> * <span class="o">(</span><span class="m">10</span> ** <span class="m">10</span><span class="o">)</span> * <span class="o">(</span><span class="m">10</span> ** <span class="m">18</span><span class="o">)</span>
      symbol
        ✓ returns correct symbol name
    init balance
      user1 has no tokens
        ✓ returns zero
      deployer has all tokens
        ✓ returns the total amount of tokens
    transfer
      normal transfers
        ✓ transfers among deployer, user1, user2 <span class="o">(</span>124ms<span class="o">)</span>
      abnormal transfers
        ✓ throws on insufficient balance <span class="o">(</span>54ms<span class="o">)</span>
    allow
      normal allow
        ✓ allows user1 to transfer from deployer <span class="o">(</span>148ms<span class="o">)</span>
      abnormal allow
        ✓ throws on insufficient balance <span class="o">(</span>43ms<span class="o">)</span>

  <span class="m">8</span> passing <span class="o">(</span>864ms<span class="o">)</span>
</pre></div>
</div>
<p>总共耗时864毫秒，不到1秒钟时间就完成了测试。在普通的Geth节点上或者以太坊主网上，一个测试就要跑至少15秒，因为要等真实区块的挖掘。一个测试集合，往往需要跑数分钟。Ganache作为测试环境下的节点还是独具优势的。</p>
<p>接下来智能合约已经具备100% 的代码覆盖测试，下一步就是上主网测试，以及发布到主网供全世界的爱好者共同运行了。本书将这个最终发布的问题，留给读者作为家庭作业解决，相信读者从本书中可以找到不止3种部署该合约到以太坊主网的方法。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../ch10/index.html" class="btn btn-neutral float-right" title="附录 有意思的冷知识" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="erc20.html" class="btn btn-neutral float-left" title="上手实践：ERC20合约" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, laalaguer.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-142187300-2', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>